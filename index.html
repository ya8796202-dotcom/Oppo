<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Windows Ultra Web Simulator</title>
<meta name="theme-color" content="#2563eb" />
<style>
  :root{
    --bg:#0b1220; --text:#e6eaf3; --muted:#b7c0d6; --panel:#121a2b; --accent:#2563eb;
    --border:#1f2940; --shadow:0 24px 60px rgba(0,0,0,.45);
    --win:#0f172a; --winHeader:#0b1220; --task:#0c1322; --hover:rgba(255,255,255,.08);
    --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:#000;color:var(--text);font-family:Segoe UI,system-ui,-apple-system,Roboto,"Noto Kufi Arabic",sans-serif}
  .desktop{
    position:relative; width:100vw; height:100vh; overflow:hidden;
    background: radial-gradient(1200px 800px at 20% 10%, #172554 0%, #0ea5e9 35%, #0f172a 85%);
  }
  /* 9 themes */
  .theme-0{background: radial-gradient(1200px 800px at 20% 10%, #172554 0%, #0ea5e9 35%, #0f172a 85%)}
  .theme-1{background: radial-gradient(1400px 900px at 80% 20%, #1e293b 0%, #22c55e 40%, #0f172a 90%)}
  .theme-2{background: radial-gradient(1200px 800px at 20% 80%, #1e293b 0%, #a855f7 40%, #0f172a 90%)}
  .theme-3{background: radial-gradient(1200px 800px at 50% 50%, #111827 0%, #f59e0b 40%, #0f172a 90%)}
  .theme-4{background: radial-gradient(1400px 900px at 30% 70%, #0f172a 0%, #ef4444 40%, #1f2937 90%)}
  .theme-5{background: radial-gradient(1400px 900px at 70% 30%, #0f172a 0%, #06b6d4 40%, #1f2937 90%)}
  .theme-6{background: radial-gradient(1400px 900px at 50% 20%, #0f172a 0%, #84cc16 40%, #1f2937 90%)}
  .theme-7{background: radial-gradient(1200px 800px at 20% 20%, #1f2937 0%, #f43f5e 40%, #0f172a 90%)}
  .theme-8{background: radial-gradient(1200px 800px at 80% 80%, #1f2937 0%, #22d3ee 40%, #0f172a 90%)}

  /* density (compact/comfortable) */
  .compact .icons{gap:8px} .compact .win{height:420px}

  /* icons grid */
  .icons{ position:absolute; inset:64px 0 64px; padding:16px; display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:12px; }
  .icon{
    display:flex; flex-direction:column; align-items:center; gap:8px; padding:10px; border-radius:12px; cursor:pointer; user-select:none;
    background:transparent; transition:.12s; color:var(--text);
  }
  .icon:hover{ background:var(--hover) }
  .icon .glyph{
    width:56px; height:56px; border-radius:12px; display:grid; place-items:center; font-size:26px; font-weight:700;
    background:linear-gradient(135deg,#3b82f6,#1d4ed8); color:#fff; box-shadow: inset 0 -10px 18px rgba(0,0,0,.25), 0 8px 18px rgba(0,0,0,.35);
  }
  .icon .label{ font-size:12px; text-align:center; max-width:120px; }

  /* taskbar */
  .taskbar{
    position:absolute; left:0; right:0; bottom:0; height:54px; background:var(--task); border-top:1px solid var(--border);
    display:flex; align-items:center; gap:8px; padding:0 10px; box-shadow:var(--shadow); backdrop-filter:saturate(130%) blur(8px);
  }
  .start-btn{ display:flex; align-items:center; gap:8px; background:transparent; color:#fff; border:0; cursor:pointer; padding:8px 12px; border-radius:12px; }
  .start-btn:hover{ background:var(--hover) }
  .start-dot{ width:24px; height:24px; border-radius:6px; background:linear-gradient(135deg,#22c55e,#16a34a); display:inline-block }
  .tasks{ flex:1; display:flex; gap:8px; align-items:center; overflow-x:auto; padding:6px 0 }
  .task{ min-width:140px; max-width:250px; padding:8px 10px; border-radius:10px; background:rgba(255,255,255,.06); color:#fff; cursor:pointer; border:1px solid var(--border); display:flex; justify-content:space-between; }
  .task.active{ outline:2px solid var(--accent) }
  .sys{ display:flex; align-items:center; gap:10px; color:var(--muted); }
  .clock{ font-weight:600 }
  .tray{ display:flex; gap:8px; align-items:center }
  .tray .btn{ padding:6px 8px }

  /* start menu */
  .start{
    position:absolute; left:10px; bottom:64px; width:460px; max-height:62vh; background:var(--panel);
    border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow); display:none; z-index:1000;
  }
  .start.show{ display:block }
  .start .search{ padding:8px; border-bottom:1px solid var(--border) }
  .start input{ width:100%; padding:10px; border-radius:8px; border:1px solid var(--border); background:#0a1020; color:#fff }
  .start .apps{ padding:10px; display:grid; grid-template-columns:repeat(3,1fr); gap:10px }
  .start .app{ display:flex; align-items:center; gap:8px; padding:8px; border-radius:10px; background:rgba(255,255,255,.06); cursor:pointer }
  .start .app:hover{ background:rgba(255,255,255,.12) }

  /* window */
  .win{
    position:absolute; top:120px; left:160px; width:820px; height:520px; background:var(--win); border:1px solid var(--border);
    border-radius:12px; box-shadow:var(--shadow); display:flex; flex-direction:column; overflow:hidden;
  }
  .win.hidden{ display:none }
  .win-header{
    height:42px; background:var(--winHeader); border-bottom:1px solid var(--border);
    display:flex; align-items:center; justify-content:space-between; padding:0 8px; cursor:move;
  }
  .win-title{ display:flex; align-items:center; gap:8px; font-weight:600 }
  .win-actions{ display:flex; gap:6px }
  .btn{ border:0; padding:6px 10px; border-radius:8px; background:rgba(255,255,255,.08); color:#fff; cursor:pointer }
  .btn:hover{ background:rgba(255,255,255,.16) }
  .win-body{ flex:1; padding:10px; overflow:auto; color:var(--muted) }
  .resize{ position:absolute; right:0; bottom:0; width:14px; height:14px; cursor:nwse-resize; background:linear-gradient(135deg,transparent 50%, rgba(255,255,255,.2) 50%) }

  /* context menu */
  .ctx{ position:absolute; background:var(--panel); border:1px solid var(--border); border-radius:10px; box-shadow:var(--shadow); display:none; z-index:2000; min-width:220px; }
  .ctx.show{ display:block }
  .ctx .item{ padding:8px 10px; cursor:pointer }
  .ctx .item:hover{ background:rgba(255,255,255,.08) }

  /* notifications */
  .toast{
    position:absolute; right:16px; bottom:70px; min-width:260px; max-width:360px;
    background:var(--panel); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); display:none; z-index:1500;
    padding:10px; color:var(--text)
  }
  .toast.show{ display:block }

  /* app styles */
  .grid2{ display:grid; grid-template-columns:220px 1fr; gap:10px; height:100% }
  .side{ border-right:1px solid var(--border); padding-right:10px }
  .item{ padding:6px 8px; border-radius:8px; cursor:pointer }
  .item:hover{ background:rgba(255,255,255,.06) }
  .files{ display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:10px }
  .file{ border:1px solid var(--border); border-radius:10px; padding:10px; background:rgba(255,255,255,.05) }

  .editor textarea{ width:100%; height:100%; padding:10px; border:1px solid var(--border); border-radius:10px; background:#0a1020; color:#fff }
  .browser-bar{ display:flex; gap:8px; margin-bottom:8px }
  .browser-bar input, .browser-bar select{ padding:8px; border-radius:8px; border:1px solid var(--border); background:#0a1020; color:#fff }
  .browser iframe{ width:100%; height:calc(100% - 50px); border:0; background:#0a1020 }

  .calc{ display:grid; grid-template-columns:repeat(4,1fr); gap:8px }
  .calc input{ grid-column:1/-1; padding:10px; border-radius:8px; background:#0a1020; border:1px solid var(--border); color:#fff }
  .calc button{ padding:10px; border-radius:8px; border:0; background:rgba(255,255,255,.08); color:#fff; cursor:pointer }
  .calc button:hover{ background:rgba(255,255,255,.16) }

  .music audio{ width:100% }
  .paint canvas{ background:#0a1020; border:1px solid var(--border); border-radius:10px }
  .tasks-app li{ display:flex; align-items:center; gap:8px; margin:6px 0 }
  .md{ display:grid; grid-template-columns:1fr 1fr; gap:10px; height:100% }
  .md textarea{ width:100%; height:100%; background:#0a1020; color:#fff; border:1px solid var(--border); border-radius:10px; padding:10px }
  .md .preview{ border:1px solid var(--border); border-radius:10px; padding:10px; overflow:auto }
  .code textarea{ width:100%; height:100%; background:#0a1020; color:#e2e8f0; font-family:Consolas,monospace; border:1px solid var(--border); border-radius:10px; padding:10px }
</style>
</head>
<body>
<div class="desktop theme-0" id="desktop">
  <!-- Desktop icons -->
  <section class="icons" id="icons"></section>

  <!-- Start menu -->
  <div class="start" id="start">
    <div class="search"><input id="startSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØªØ·Ø¨ÙŠÙ‚" /></div>
    <div class="apps" id="startApps"></div>
  </div>

  <!-- Taskbar -->
  <footer class="taskbar">
    <button class="start-btn" id="startBtn"><span class="start-dot"></span><span>Ø§Ø¨Ø¯Ø£</span></button>
    <div class="tasks" id="tasks"></div>
    <div class="sys">
      <div class="tray">
        <button class="btn" id="snapL">Snap ÙŠØ³Ø§Ø±</button>
        <button class="btn" id="snapR">Snap ÙŠÙ…ÙŠÙ†</button>
        <button class="btn" id="showDesk">Ø¥Ø¸Ù‡Ø§Ø± Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨</button>
      </div>
      <span class="clock" id="clock">00:00</span>
    </div>
  </footer>

  <!-- Context menu -->
  <div class="ctx" id="ctx">
    <div class="item" data-cmd="new-note">Ù…Ø°ÙƒØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>
    <div class="item" data-cmd="new-window">Ù†Ø§ÙØ°Ø© ÙØ§Ø±ØºØ©</div>
    <div class="item" data-cmd="theme">ØªØºÙŠÙŠØ± Ø§Ù„Ø®Ù„ÙÙŠØ©</div>
    <div class="item" data-cmd="density">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ«Ø§ÙØ©</div>
    <div class="item" data-cmd="settings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
    <div class="item" data-cmd="store">Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>
</div>

<script>
/* =========================
   APPS REGISTRY â€” Ø£Ø¶Ù/ÙˆØ³Ù‘Ø¹ Ø¨Ø­Ø±ÙŠØ©
   ========================= */
const REGISTRY = [
  { id:'explorer',  name:'Ø§Ù„Ù…Ø³ØªÙƒØ´Ù',    glyph:'ğŸ“' },
  { id:'notepad',   name:'Ø§Ù„Ù…ÙÙƒØ±Ø©',     glyph:'ğŸ“' },
  { id:'browser',   name:'Ø§Ù„Ù…ØªØµÙØ­ (Pro)', glyph:'ğŸŒ' },
  { id:'terminal',  name:'Ø§Ù„Ø·Ø±ÙÙŠØ©',     glyph:'>_' },
  { id:'settings',  name:'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',    glyph:'âš™ï¸' },
  { id:'calculator',name:'Ø§Ù„Ø­Ø§Ø³Ø¨Ø©',     glyph:'ğŸ§®' },
  { id:'music',     name:'Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰',     glyph:'ğŸµ' },
  { id:'gallery',   name:'Ø§Ù„Ù…Ø¹Ø±Ø¶',       glyph:'ğŸ–¼ï¸' },
  { id:'paint',     name:'Ø§Ù„Ø±Ø³Ø§Ù…',       glyph:'ğŸ¨' },
  { id:'todo',      name:'Ø§Ù„Ù…Ù‡Ø§Ù…',       glyph:'âœ…' },
  { id:'store',     name:'Ù…ØªØ¬Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª', glyph:'ğŸ›ï¸' },
  { id:'calendar',  name:'Ø§Ù„ØªÙ‚ÙˆÙŠÙ…',      glyph:'ğŸ“…' },
  { id:'mail',      name:'Ø§Ù„Ø¨Ø±ÙŠØ¯',       glyph:'âœ‰ï¸' },
  { id:'video',     name:'Ø§Ù„ÙÙŠØ¯ÙŠÙˆ',      glyph:'ğŸ“º' },
  { id:'markdown',  name:'Markdown',     glyph:'ğŸ—’ï¸' },
  { id:'code',      name:'Ù…Ø­Ø±Ø± ÙƒÙˆØ¯',     glyph:'ğŸ’»' },
];

const DESKTOP = [
  'explorer','browser','notepad','calculator','gallery','music','paint','todo','calendar','mail','video','markdown','code','settings','store'
];

/* =========================
   STATE
   ========================= */
let zCounter = 10;
const windows = new Map(); // id -> dom
const tasks = new Map();   // id -> task button
let themeIndex = Number(localStorage.getItem('themeIndex') || 0);
let compact = localStorage.getItem('density') === 'compact';

/* =========================
   UTIL
   ========================= */
const desk = document.getElementById('desktop');
const iconsEl = document.getElementById('icons');
const startEl = document.getElementById('start');
const startBtn = document.getElementById('startBtn');
const startApps = document.getElementById('startApps');
const startSearch = document.getElementById('startSearch');
const tasksEl = document.getElementById('tasks');
const clockEl = document.getElementById('clock');
const ctxEl = document.getElementById('ctx');
const toastEl = document.getElementById('toast');
const snapL = document.getElementById('snapL');
const snapR = document.getElementById('snapR');
const showDesk = document.getElementById('showDesk');

function clockTick(){
  const d=new Date(); const h=d.getHours().toString().padStart(2,'0'); const m=d.getMinutes().toString().padStart(2,'0');
  clockEl.textContent = `${h}:${m}`;
}
setInterval(clockTick, 1000); clockTick();

function toast(msg){ toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), 2500); }

/* =========================
   DESKTOP & START MENU
   ========================= */
function buildDesktop(){
  iconsEl.innerHTML='';
  DESKTOP.forEach(id=>{
    const a = REGISTRY.find(x=>x.id===id);
    const div = document.createElement('div');
    div.className='icon';
    div.dataset.app=a.id;
    div.innerHTML = `<div class="glyph">${a.glyph}</div><div class="label">${a.name}</div>`;
    div.addEventListener('dblclick', ()=>openApp(a.id));
    iconsEl.appendChild(div);
  });
}
function buildStart(){
  startApps.innerHTML='';
  REGISTRY.forEach(a=>{
    const row = document.createElement('div');
    row.className='app';
    row.dataset.app=a.id;
    row.innerHTML = `<span class="glyph" style="width:28px;height:28px;border-radius:6px;display:grid;place-items:center;background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff">${a.glyph}</span><span>${a.name}</span>`;
    row.addEventListener('click', ()=>{ openApp(a.id); toggleStart(false); });
    startApps.appendChild(row);
  });
}
function toggleStart(show){ startEl.classList.toggle('show', show ?? !startEl.classList.contains('show')); }
startBtn.addEventListener('click', ()=>toggleStart());
desk.addEventListener('click', (e)=>{
  if (!startEl.contains(e.target) && !startBtn.contains(e.target)) toggleStart(false);
  if (!ctxEl.contains(e.target)) ctxEl.classList.remove('show');
});
startSearch.addEventListener('input', ()=>{
  const q = startSearch.value.trim();
  [...startApps.children].forEach(el=>{
    const name = el.textContent.toLowerCase();
    el.style.display = name.includes(q.toLowerCase())?'flex':'none';
  });
});

/* =========================
   WINDOWS & TASKS & SNAP
   ========================= */
function openApp(id){
  const app = REGISTRY.find(x=>x.id===id);
  if (!app) return;
  let win = windows.get(id);
  if (!win){
    win = createWindow(app);
    windows.set(id, win);
    const t = createTask(app);
    tasks.set(id, t);
  }
  focusWindow(win);
}
function createTask(app){
  const t = document.createElement('button');
  t.className='task';
  t.dataset.app=app.id;
  t.innerHTML = `<span>${app.name}</span><span>â– </span>`;
  t.onclick = ()=>openApp(app.id);
  tasksEl.appendChild(t);
  return t;
}
function focusWindow(win){
  document.querySelectorAll('.win').forEach(w=>w.classList.remove('active'));
  win.style.zIndex = ++zCounter;
  const task = tasks.get(win.dataset.app);
  document.querySelectorAll('.task').forEach(t=>t.classList.remove('active'));
  if (task) task.classList.add('active');
  win.classList.remove('hidden');
}
function createWindow(app){
  const w = document.createElement('div');
  w.className='win';
  w.dataset.app=app.id;
  w.style.top = (72 + Math.random()*60)+'px';
  w.style.left = (90 + Math.random()*120)+'px';

  const header = document.createElement('div');
  header.className='win-header';
  header.innerHTML = `<div class="win-title"><span style="width:22px;height:22px;border-radius:6px;display:grid;place-items:center;background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff">${app.glyph}</span>${app.name}</div>
  <div class="win-actions">
    <button class="btn" data-act="min">ØªØµØºÙŠØ±</button>
    <button class="btn" data-act="max">ØªÙƒØ¨ÙŠØ±</button>
    <button class="btn" data-act="close">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>`;
  const body = document.createElement('div'); body.className='win-body'; body.appendChild(renderApp(app.id));
  const res = document.createElement('div'); res.className='resize';

  w.appendChild(header); w.appendChild(body); w.appendChild(res);
  desk.appendChild(w);

  // drag
  let dx=0, dy=0, dragging=false;
  header.addEventListener('mousedown', e=>{ dragging=true; dx=e.clientX - w.offsetLeft; dy=e.clientY - w.offsetTop; });
  window.addEventListener('mousemove', e=>{ if(dragging){ w.style.left = (e.clientX - dx)+'px'; w.style.top = (e.clientY - dy)+'px'; } });
  window.addEventListener('mouseup', ()=>dragging=false);

  // resize
  let rs=false, sx=0, sy=0, sw=0, sh=0;
  res.addEventListener('mousedown', e=>{ rs=true; sx=e.clientX; sy=e.clientY; sw=w.offsetWidth; sh=w.offsetHeight; e.preventDefault(); });
  window.addEventListener('mousemove', e=>{ if(rs){ w.style.width = Math.max(440, sw + (e.clientX - sx))+'px'; w.style.height = Math.max(300, sh + (e.clientY - sy))+'px'; } });
  window.addEventListener('mouseup', ()=>rs=false);

  // actions
  header.querySelectorAll('.btn').forEach(b=>{
    b.addEventListener('click', ()=>{
      const act=b.dataset.act;
      if (act==='close'){ w.classList.add('hidden'); const t=tasks.get(app.id); if(t) t.remove(); tasks.delete(app.id); windows.delete(app.id); }
      if (act==='min'){ w.classList.add('hidden'); const t=tasks.get(app.id); if(t) t.classList.remove('active'); }
      if (act==='max'){ w.style.top='48px'; w.style.left='16px'; w.style.width='calc(100vw - 32px)'; w.style.height='calc(100vh - 110px)'; focusWindow(w); }
    });
  });

  // focus on click
  w.addEventListener('mousedown', ()=>focusWindow(w));
  return w;
}

// Snap helpers
function activeWindow(){
  const id = [...tasks.keys()].find(k => tasks.get(k).classList.contains('active'));
  return id ? windows.get(id) : null;
}
snapL.onclick = ()=>{
  const w = activeWindow(); if(!w) return toast('Ø§Ø®ØªØ± Ù†Ø§ÙØ°Ø© Ø£ÙˆÙ„Ù‹Ø§');
  w.style.top='48px'; w.style.left='16px'; w.style.width='calc(50vw - 24px)'; w.style.height='calc(100vh - 110px)';
};
snapR.onclick = ()=>{
  const w = activeWindow(); if(!w) return toast('Ø§Ø®ØªØ± Ù†Ø§ÙØ°Ø© Ø£ÙˆÙ„Ù‹Ø§');
  w.style.top='48px'; w.style.left='calc(50vw + 8px)'; w.style.width='calc(50vw - 24px)'; w.style.height='calc(100vh - 110px)';
};
showDesk.onclick = ()=>{
  document.querySelectorAll('.win').forEach(w=>w.classList.add('hidden'));
  document.querySelectorAll('.task').forEach(t=>t.classList.remove('active'));
};

/* =========================
   APPS RENDERERS
   ========================= */
function renderApp(id){
  if (id==='explorer'){
    const wrap = document.createElement('div'); wrap.className='grid2';
    const side = document.createElement('div'); side.className='side';
    side.innerHTML = `<div class="item" data-path="Desktop">Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨</div>
                      <div class="item" data-path="Documents">Ù…Ø³ØªÙ†Ø¯Ø§Øª</div>
                      <div class="item" data-path="Downloads">ØªÙ†Ø²ÙŠÙ„Ø§Øª</div>`;
    const main = document.createElement('div'); main.className='files';
    wrap.appendChild(side); wrap.appendChild(main);

    const filesDB = JSON.parse(localStorage.getItem('filesDB')||'{}');
    function list(path){
      main.innerHTML='';
      const items = filesDB[path] || sampleFiles(path);
      items.forEach(f=>{
        const div = document.createElement('div'); div.className='file';
        div.innerHTML = `<div style="font-weight:600">${f.name}</div><div style="font-size:12px;color:var(--muted)">${f.type} â€¢ ${f.size}</div>`;
        div.addEventListener('dblclick', ()=>{ if (f.app) openApp(f.app); });
        main.appendChild(div);
      });
    }
    function sampleFiles(path){
      const samples={
        Desktop:[{name:'Ù…ÙÙƒØ±Ø©.txt',type:'Text',size:'2 KB',app:'notepad'},{name:'ØªØ¹Ù„ÙŠÙ…Ø§Øª.html',type:'HTML',size:'4 KB',app:'browser'}],
        Documents:[{name:'Ù…Ø´Ø±ÙˆØ¹.md',type:'Markdown',size:'3 KB',app:'markdown'}],
        Downloads:[{name:'index.html',type:'HTML',size:'6 KB',app:'browser'}]
      }; return samples[path]||[];
    }
    side.querySelectorAll('.item').forEach(el=>el.addEventListener('click', ()=>list(el.dataset.path)));
    list('Desktop'); return wrap;
  }

  if (id==='notepad'){
    const wrap = document.createElement('div'); wrap.className='editor';
    wrap.innerHTML = `<div style="display:flex;gap:8px;margin-bottom:8px">
      <button class="btn" id="noteSave">Ø­ÙØ¸</button>
      <button class="btn" id="noteLoad">ØªØ­Ù…ÙŠÙ„</button>
      <button class="btn" id="noteNew">Ø¬Ø¯ÙŠØ¯</button>
    </div><textarea id="noteArea" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§..."></textarea>`;
    const area = wrap.querySelector('#noteArea');
    wrap.querySelector('#noteSave').onclick = ()=>{ localStorage.setItem('notepad', area.value); toast('ØªÙ… Ø§Ù„Ø­ÙØ¸'); };
    wrap.querySelector('#noteLoad').onclick = ()=>{ area.value = localStorage.getItem('notepad')||''; toast('ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„'); };
    wrap.querySelector('#noteNew').onclick = ()=>{ area.value=''; };
    return wrap;
  }

  if (id==='browser'){
    const wrap = document.createElement('div'); wrap.className='browser';
    wrap.innerHTML = `<div class="browser-bar">
      <select id="mode">
        <option value="external">ÙØªØ­ ÙƒØ§Ù…Ù„ (ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯)</option>
        <option value="embed">ØªØ¶Ù…ÙŠÙ† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø©</option>
      </select>
      <input id="url" placeholder="https://www.google.com" value="https://www.google.com">
      <button class="btn" id="go">Ø§Ø°Ù‡Ø¨</button>
    </div>
    <iframe id="frame" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
    <div style="margin-top:8px;color:var(--muted)">Ø¨Ø¹Ø¶ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ (Ù…Ø«Ù„ Google) Ù‚Ø¯ ØªÙ…Ù†Ø¹ Ø§Ù„ØªØ¶Ù…ÙŠÙ† Ø¯Ø§Ø®Ù„ iframe. Ø§Ø³ØªØ®Ø¯Ù… ÙˆØ¶Ø¹ "ÙØªØ­ ÙƒØ§Ù…Ù„" Ù„Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ù‚ÙŠØ¯Ø©.</div>`;
    const mode = wrap.querySelector('#mode'); const url = wrap.querySelector('#url'); const frame = wrap.querySelector('#frame');
    function navigate(){
      const u = url.value.trim(); if (!u) return;
      const full = u.startsWith('http') ? u : ('https://' + u);
      if (mode.value === 'external'){ window.open(full, '_blank', 'noopener,noreferrer'); toast('ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯'); }
      else { frame.src = full; }
    }
    wrap.querySelector('#go').onclick = navigate;
    url.addEventListener('keydown', e=>{ if(e.key==='Enter') navigate(); });
    return wrap;
  }

  if (id==='terminal'){
    const wrap = document.createElement('div'); wrap.className='editor';
    wrap.innerHTML = `<div class="terminal" style="background:#0a1020;color:#e2e8f0;padding:10px;border-radius:10px">
      <div>Terminal â€” Ø§ÙƒØªØ¨ Ø£Ù…Ø±Ù‹Ø§ Ø«Ù… Enter</div>
      <div id="out" style="margin:8px 0;white-space:pre-wrap"></div>
      <div><span style="color:#22c55e">C:\\></span> <input id="cmd" style="width:80%;background:#0a1020;border:1px solid var(--border);color:#fff;padding:6px;border-radius:8px"></div>
    </div>`;
    const out = wrap.querySelector('#out'); const cmd = wrap.querySelector('#cmd');
    const cmds = {
      help: ()=>"Ø§Ù„Ø£ÙˆØ§Ù…Ø±: help, echo <text>, date, ls, clear, theme <0..8>, density <compact|comfortable>",
      echo: (args)=>args.join(' '),
      date: ()=>new Date().toString(),
      ls: ()=>"Desktop Documents Downloads",
      clear: ()=>{ out.textContent=''; return ''; },
      theme: (args)=>{ const n=Number(args[0]||0); setTheme(n); return 'ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¥Ù„Ù‰ '+n; },
      density: (args)=>{ setDensity(args[0]==='compact'); return 'ØªÙ… Ø¶Ø¨Ø· Ø§Ù„ÙƒØ«Ø§ÙØ©:'+(args[0]||'comfortable'); }
    };
    cmd.addEventListener('keydown', e=>{
      if (e.key==='Enter'){
        const parts = cmd.value.trim().split(/\s+/); const name=parts.shift().toLowerCase();
        const fn = cmds[name]; let res='';
        if (fn) res = fn(parts)||'';
        else res = 'Ø£Ù…Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ: '+name;
        out.textContent += `\n$ ${cmd.value}\n${res}`;
        cmd.value='';
      }
    });
    return wrap;
  }

  if (id==='settings'){
    const wrap = document.createElement('div'); wrap.style.padding='6px';
    wrap.innerHTML = `<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
      <div class="file"><div style="font-weight:600">Ø§Ù„Ø³ÙÙ…Ø©</div>
        <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
          ${Array.from({length:9}).map((_,i)=>`<button class="btn" data-theme="${i}">Ø«ÙŠÙ… ${i}</button>`).join('')}
        </div>
      </div>
      <div class="file"><div style="font-weight:600">Ø§Ù„ÙƒØ«Ø§ÙØ©</div>
        <div style="margin-top:6px;display:flex;gap:8px">
          <button class="btn" id="compact">Ù…Ø¶ØºÙˆØ·</button>
          <button class="btn" id="comfortable">Ù…Ø±ÙŠØ­</button>
        </div>
      </div>
      <div class="file"><div style="font-weight:600">Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</div>
        <div style="margin-top:6px"><button class="btn" id="notify">Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø±</button></div>
      </div>
      <div class="file"><div style="font-weight:600">Ø­ÙˆÙ„</div>
        <div style="margin-top:6px;color:var(--muted)">Windows Ultra Web Simulator â€” Ù…Ù„Ù ÙˆØ§Ø­Ø¯ØŒ PWAØŒ Ù…ØªØ¬Ø± Ø¯Ø§Ø®Ù„ÙŠØŒ Ù…ØªØµÙØ­ Ø¨ÙˆØ¶Ø¹ÙŠÙ†ØŒ ÙˆRegistry Ù„Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ø¯ ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª.</div>
      </div>
    </div>`;
    wrap.querySelectorAll('[data-theme]').forEach(b=> b.onclick = ()=> setTheme(Number(b.dataset.theme)));
    wrap.querySelector('#compact').onclick = ()=> setDensity(true);
    wrap.querySelector('#comfortable').onclick = ()=> setDensity(false);
    wrap.querySelector('#notify').onclick = ()=>toast('Ù‡Ø°Ø§ Ø¥Ø´Ø¹Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ ğŸ‰');
    return wrap;
  }

  if (id==='calculator'){
    const wrap = document.createElement('div'); wrap.className='calc';
    wrap.innerHTML = `<input id="calcIn" placeholder="3+4*2">
      ${['7','8','9','/','4','5','6','*','1','2','3','-','0','.','=','+'].map(k=>`<button>${k}</button>`).join('')}
      <div id="calcOut" style="grid-column:1/-1;color:var(--muted)"></div>`;
    const out = wrap.querySelector('#calcOut'); const input = wrap.querySelector('#calcIn');
    wrap.querySelectorAll('button').forEach(b=>{
      b.onclick = ()=>{
        const k=b.textContent;
        if(k==='='){ try{ out.textContent = 'Ø§Ù„Ù†ØªÙŠØ¬Ø©: ' + Function('return '+input.value)(); } catch{ out.textContent='ØµÙŠØºØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©'; } }
        else input.value += k;
      };
    });
    return wrap;
  }

  if (id==='music'){
    const wrap = document.createElement('div'); wrap.className='music';
    wrap.innerHTML = `<div style="margin-bottom:8px">Ù…Ø´ØºÙ„ Ù…ÙˆØ³ÙŠÙ‚Ù‰ â€” Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· MP3:</div>
      <input id="src" placeholder="https://example.com/track.mp3" style="width:100%;padding:8px;border-radius:8px;background:#0a1020;border:1px solid var(--border);color:#fff">
      <audio id="player" controls></audio>`;
    const src = wrap.querySelector('#src'); const player = wrap.querySelector('#player');
    src.addEventListener('keydown', e=>{ if(e.key==='Enter'){ player.src = src.value.trim(); player.play().catch(()=>{}); } });
    return wrap;
  }

  if (id==='video'){
    const wrap = document.createElement('div');
    wrap.innerHTML = `<div style="margin-bottom:8px">Ù…Ø´ØºÙ„ ÙÙŠØ¯ÙŠÙˆ â€” Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· mp4/m3u8 (Ù‚Ø¯ ØªØ®ØªÙ„Ù Ø§Ù„ØªÙˆØ§ÙÙ‚ÙŠØ©):</div>
      <input id="vsrc" placeholder="https://example.com/video.mp4" style="width:100%;padding:8px;border-radius:8px;background:#0a1020;border:1px solid var(--border);color:#fff">
      <video id="vplayer" controls style="width:100%;max-height:360px;background:#000"></video>`;
    const src = wrap.querySelector('#vsrc'); const player = wrap.querySelector('#vplayer');
    src.addEventListener('keydown', e=>{ if(e.key==='Enter'){ player.src = src.value.trim(); player.play().catch(()=>{}); } });
    return wrap;
  }

  if (id==='gallery'){
    const wrap = document.createElement('div'); wrap.className='files';
    const imgs = JSON.parse(localStorage.getItem('gallery')||'[]');
    function render(){
      wrap.innerHTML='';
      imgs.forEach((u,i)=>{
        const card = document.createElement('div'); card.className='file';
        card.innerHTML = `<img src="${u}" style="width:100%;height:160px;object-fit:cover;border-radius:8px"><div style="margin-top:6px;font-size:12px;color:var(--muted)">ØµÙˆØ±Ø© ${i+1}</div>`;
        wrap.appendChild(card);
      });
      const add = document.createElement('div'); add.className='file';
      add.innerHTML = `<div style="display:flex;gap:8px;align-items:center">
        <input id="imgUrl" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø©..." style="flex:1;padding:8px;border-radius:8px;background:#0a1020;border:1px solid var(--border);color:#fff">
        <button class="btn" id="addImg">Ø¥Ø¶Ø§ÙØ©</button>
      </div>`;
      add.querySelector('#addImg').onclick = ()=>{
        const u = add.querySelector('#imgUrl').value.trim();
        if(u){ imgs.push(u); localStorage.setItem('gallery', JSON.stringify(imgs)); render(); toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø©'); }
      };
      wrap.appendChild(add);
    }
    render(); return wrap;
  }

  if (id==='paint'){
    const wrap = document.createElement('div'); wrap.className='paint';
    wrap.innerHTML = `<div style="margin-bottom:8px;display:flex;gap:8px">
      <label>Ø§Ù„Ø­Ø¬Ù… <input id="size" type="range" min="2" max="24" value="6"></label>
      <input id="color" type="color" value="#22c55e">
      <button class="btn" id="clear">Ù…Ø³Ø­</button>
    </div><canvas id="c" width="800" height="380"></canvas>`;
    const c = wrap.querySelector('#c'); const ctx = c.getContext('2d');
    let drawing=false, size=6, color='#22c55e';
    c.addEventListener('mousedown', e=>{ drawing=true; draw(e); });
    c.addEventListener('mousemove', e=>{ if(drawing) draw(e); });
    window.addEventListener('mouseup', ()=>drawing=false);
    function draw(e){ const rect=c.getBoundingClientRect(); const x=e.clientX-rect.left; const y=e.clientY-rect.top; ctx.fillStyle=color; ctx.beginPath(); ctx.arc(x,y,size,0,Math.PI*2); ctx.fill(); }
    wrap.querySelector('#size').oninput = e=> size=Number(e.target.value);
    wrap.querySelector('#color').oninput = e=> color=e.target.value;
    wrap.querySelector('#clear').onclick = ()=> ctx.clearRect(0,0,c.width,c.height);
    return wrap;
  }

  if (id==='todo'){
    const wrap = document.createElement('div');
    wrap.innerHTML = `<div style="display:flex;gap:8px;margin-bottom:8px">
      <input id="taskIn" placeholder="Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©" style="flex:1;padding:8px;border-radius:8px;background:#0a1020;border:1px solid var(--border);color:#fff">
      <button class="btn" id="add">Ø¥Ø¶Ø§ÙØ©</button>
    </div><ul id="list" class="tasks-app" style="list-style:none;padding:0;margin:0"></ul>`;
    const list = wrap.querySelector('#list');
    const tasksDB = JSON.parse(localStorage.getItem('tasksDB')||'[]');
    function render(){
      list.innerHTML='';
      tasksDB.forEach((t,i)=>{
        const li = document.createElement('li');
        li.innerHTML = `<input type="checkbox" ${t.done?'checked':''}> <span>${t.text}</span> <button class="btn" data-i="${i}">Ø­Ø°Ù</button>`;
        li.querySelector('input').onchange = e=>{ t.done = e.target.checked; save(); render(); };
        li.querySelector('button').onclick = e=>{ tasksDB.splice(Number(e.target.dataset.i),1); save(); render(); };
        list.appendChild(li);
      });
    }
    function save(){ localStorage.setItem('tasksDB', JSON.stringify(tasksDB)); }
    wrap.querySelector('#add').onclick = ()=>{
      const val = wrap.querySelector('#taskIn').value.trim(); if(!val) return;
      tasksDB.push({text:val, done:false}); save(); render(); wrap.querySelector('#taskIn').value='';
    };
    render(); return wrap;
  }

  if (id==='store'){
    const wrap = document.createElement('div');
    wrap.innerHTML = `<div style="margin-bottom:8px;color:var(--muted)">Ù…ØªØ¬Ø± ÙˆÙ‡Ù…ÙŠ â€” Ø«Ø¨Øª/Ø£Ø¶Ù Ø§Ø®ØªØµØ§Ø±Ø§Øª ÙˆØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø³Ø±Ø¹Ø©.</div>
      <div class="files" id="appsGrid"></div>`;
    const appsGrid = wrap.querySelector('#appsGrid');
    const catalog = [
      {id:'notes2', name:'Ù…ÙÙƒØ±Ø© Ù…ØªÙ‚Ø¯Ù…Ø©', glyph:'ğŸ—’ï¸', install:()=>toast('ØªØ«Ø¨ÙŠØª ØªØ¬Ø±ÙŠØ¨ÙŠ â€” Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙÙƒØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©')},
      {id:'player', name:'Ù…Ø´ØºÙ„ ÙÙŠØ¯ÙŠÙˆ Ù…ØªÙ‚Ø¯Ù…', glyph:'ğŸ¬', install:()=>openApp('video')},
      {id:'camera', name:'ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆÙŠØ¨', glyph:'ğŸ“·', install:()=>toast('ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© getUserMedia Ù„Ø§Ø­Ù‚Ù‹Ø§')},
      {id:'maps', name:'Ø®Ø±Ø§Ø¦Ø· (ØªØ¶Ù…ÙŠÙ†)', glyph:'ğŸ—ºï¸', install:()=>embedShortcut('browser','https://www.openstreetmap.org')}
    ];
    function card(app){
      const div = document.createElement('div'); div.className='file';
      div.innerHTML = `<div style="font-weight:600">${app.name}</div><div style="font-size:12px;color:var(--muted)">${app.glyph}</div>
        <div style="margin-top:8px"><button class="btn">ØªØ«Ø¨ÙŠØª</button></div>`;
      div.querySelector('.btn').onclick = ()=> app.install();
      return div;
    }
    catalog.forEach(a=> appsGrid.appendChild(card(a)));
    return wrap;
  }

  if (id==='calendar'){
    const wrap = document.createElement('div');
    const d = new Date();
    wrap.innerHTML = `<div style="margin-bottom:8px;font-weight:600">ØªÙ‚ÙˆÙŠÙ… ${d.getFullYear()}</div>
      <div id="cal"></div>`;
    const cal = wrap.querySelector('#cal');
    function renderMonth(year, month){
      const first = new Date(year,month,1); const days = new Date(year,month+1,0).getDate();
      const grid = document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(7,1fr)'; grid.style.gap='6px';
      const names=['Ø£Ø­Ø¯','Ø§Ø«Ù†ÙŠÙ†','Ø«Ù„Ø§Ø«Ø§Ø¡','Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø®Ù…ÙŠØ³','Ø¬Ù…Ø¹Ø©','Ø³Ø¨Øª'];
      names.forEach(n=>{ const h=document.createElement('div'); h.style.color='var(--muted)'; h.textContent=n; grid.appendChild(h); });
      for(let i=0;i<first.getDay();i++){ grid.appendChild(document.createElement('div')); }
      for(let d=1; d<=days; d++){ const cell=document.createElement('div'); cell.className='file'; cell.textContent=d; grid.appendChild(cell); }
      return grid;
    }
    cal.appendChild(renderMonth(d.getFullYear(), d.getMonth()));
    return wrap;
  }

  if (id==='mail'){
    const wrap = document.createElement('div');
    const inbox = JSON.parse(localStorage.getItem('inbox')||'[]');
    wrap.innerHTML = `<div style="display:grid;grid-template-columns:240px 1fr;gap:10px">
      <div>
        <button class="btn" id="compose">Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        <div id="list" style="margin-top:10px"></div>
      </div>
      <div id="view" class="file">Ø§Ø®ØªØ± Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¹Ø±Ø¶</div>
    </div>`;
    const list = wrap.querySelector('#list'); const view = wrap.querySelector('#view');
    function render(){
      list.innerHTML='';
      inbox.forEach((m,i)=>{
        const item = document.createElement('div'); item.className='item'; item.textContent = (m.subject||'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†');
        item.onclick = ()=> view.innerHTML = `<div style="font-weight:600">${m.subject}</div><div style="margin-top:8px">${m.body}</div>`;
        list.appendChild(item);
      });
    }
    wrap.querySelector('#compose').onclick = ()=>{
      const subj = prompt('Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:'); const body = (subj?prompt('Ø§Ù„Ù…Ø­ØªÙˆÙ‰:'):'');
      if (subj){ inbox.unshift({subject:subj, body:body||''}); localStorage.setItem('inbox', JSON.stringify(inbox)); render(); toast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„/Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø©'); }
    };
    render(); return wrap;
  }

  if (id==='markdown'){
    const wrap = document.createElement('div'); wrap.className='md';
    wrap.innerHTML = `<textarea id="mdIn" placeholder="# Ø¹Ù†ÙˆØ§Ù†\n\nÙ†Øµ **ØºØ§Ù…Ù‚**ØŒ *Ù…Ø§Ø¦Ù„*, ÙˆÙ‚Ø§Ø¦Ù…Ø©:\n- Ø¹Ù†ØµØ± 1\n- Ø¹Ù†ØµØ± 2"></textarea>
      <div class="preview" id="mdOut"></div>`;
    const input = wrap.querySelector('#mdIn'); const out = wrap.querySelector('#mdOut');
    function renderMD(src){
      let html = src
        .replace(/^# (.*)$/gm, '<h2>$1</h2>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/^- (.*)$/gm, '<li>$1</li>');
      html = html.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
      out.innerHTML = html;
    }
    input.addEventListener('input', ()=> renderMD(input.value));
    renderMD(input.value); return wrap;
  }

  if (id==='code'){
    const wrap = document.createElement('div'); wrap.className='code';
    wrap.innerHTML = `<div style="display:flex;gap:8px;margin-bottom:8px">
      <button class="btn" id="run">ØªØ´ØºÙŠÙ„ HTML</button>
      <button class="btn" id="save">Ø­ÙØ¸</button>
      <button class="btn" id="load">ØªØ­Ù…ÙŠÙ„</button>
    </div><textarea id="src" placeholder="Ø§ÙƒØªØ¨ HTML/CSS/JS Ø¨Ø³ÙŠØ· Ù‡Ù†Ø§..."></textarea>
    <iframe id="out" sandbox="allow-scripts allow-same-origin" style="width:100%;height:280px;border:0;margin-top:8px;background:#0a1020"></iframe>`;
    const src = wrap.querySelector('#src'); const out = wrap.querySelector('#out');
    wrap.querySelector('#run').onclick = ()=>{
      const blob = new Blob([src.value], {type:'text/html'}); out.src = URL.createObjectURL(blob);
    };
    wrap.querySelector('#save').onclick = ()=>{ localStorage.setItem('codepad', src.value); toast('ØªÙ… Ø§Ù„Ø­ÙØ¸'); };
    wrap.querySelector('#load').onclick = ()=>{ src.value = localStorage.getItem('codepad')||''; toast('ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„'); };
    return wrap;
  }

  // fallback
  const div = document.createElement('div'); div.textContent='ØªØ·Ø¨ÙŠÙ‚ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'; return div;
}

/* =========================
   PLUGINS / SHORTCUT HELPERS
   ========================= */
function embedShortcut(appId, param){
  // Ù…Ø«Ø§Ù„: ÙŠÙØªØ­ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ø¹ URL Ù…Ø­Ø¯Ø¯
  openApp(appId);
  // ÙŠÙ…ÙƒÙ† ØªÙˆØ³ÙŠØ¹ Ø±Ø¨Ø· Ø§Ù„Ù…Ø¹Ù„Ù…Ø§Øª Ø¹Ø¨Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ø§Ø­Ù‚Ù‹Ø§
}

/* =========================
   CONTEXT MENU & THEMES & DENSITY
   ========================= */
desk.addEventListener('contextmenu', e=>{
  e.preventDefault();
  ctxEl.style.left = e.clientX+'px';
  ctxEl.style.top  = e.clientY+'px';
  ctxEl.classList.add('show');
});
ctxEl.addEventListener('click', e=>{
  const cmd = e.target.dataset.cmd;
  ctxEl.classList.remove('show');
  if (cmd==='new-note') openApp('notepad');
  if (cmd==='new-window'){ const tmpId='blank-'+Math.random().toString(36).slice(2); REGISTRY.push({id:tmpId,name:'Ù†Ø§ÙØ°Ø©',glyph:'ğŸªŸ'}); openApp(tmpId); }
  if (cmd==='theme') setTheme((themeIndex+1)%9);
  if (cmd==='density') setDensity(!compact);
  if (cmd==='settings') openApp('settings');
  if (cmd==='store') openApp('store');
});
function setTheme(i){
  themeIndex = i;
  desk.className = 'desktop theme-'+i + (compact?' compact':'');
  localStorage.setItem('themeIndex', i);
}
function setDensity(isCompact){
  compact = !!isCompact;
  desk.className = 'desktop theme-'+themeIndex + (compact?' compact':'');
  localStorage.setItem('density', compact?'compact':'comfortable');
}

/* =========================
   INIT
   ========================= */
buildDesktop();
buildStart();
setTheme(themeIndex);
setDensity(compact);

/* =========================
   PWA â€” Manifest & Service Worker (inline)
   ========================= */
const manifest = {
  name: "Windows Ultra Web Simulator",
  short_name: "WinUltra",
  start_url: "./index.html",
  display: "standalone",
  background_color: "#0b1220",
  theme_color: "#2563eb",
  icons: [{
    src: "data:image/svg+xml;base64,"+btoa('<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 256 256\"><rect width=\"256\" height=\"256\" rx=\"48\" fill=\"#2563eb\"/><g fill=\"#fff\"><rect x=\"24\" y=\"24\" width=\"104\" height=\"104\"/><rect x=\"136\" y=\"24\" width=\"96\" height=\"104\"/><rect x=\"24\" y=\"136\" width=\"104\" height=\"96\"/><rect x=\"136\" y=\"136\" width=\"96\" height=\"96\"/></g></svg>'),
    sizes: "256x256",
    type: "image/svg+xml",
    purpose: "any maskable"
  }]
};
const manifestURL = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'}));
const linkManifest = document.createElement('link'); linkManifest.rel='manifest'; linkManifest.href=manifestURL; document.head.appendChild(linkManifest);

const swCode = `
  const CACHE='win-ultra-v1';
  const ASSETS=['./','./index.html'];
  self.addEventListener('install',e=>{
    e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)).then(()=>self.skipWaiting()));
  });
  self.addEventListener('activate',e=>{
    e.waitUntil(caches.keys().then(keys=>Promise.all(keys.map(k=>k!==CACHE&&caches.delete(k)))));
    self.clients.claim();
  });
  self.addEventListener('fetch',e=>{
    if(e.request.method!=='GET') return;
    const url = new URL(e.request.url);
    e.respondWith(
      caches.match(e.request).then(res=>res||fetch(e.request).then(net=>{
        if(url.origin===self.location.origin){
          const clone=net.clone(); caches.open(CACHE).then(c=>c.put(e.request, clone));
        }
        return net;
      }).catch(()=>caches.match('./index.html')))
    );
  });
`;
const swURL = URL.createObjectURL(new Blob([swCode], {type:'application/javascript'}));
if ('serviceWorker' in navigator){ navigator.serviceWorker.register(swURL); }
</script>
</body>
</html>
